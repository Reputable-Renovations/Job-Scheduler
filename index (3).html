<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Job Scheduler</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#f1f5f9,#e2e8f0);min-height:100vh}
    .header{background:linear-gradient(90deg,#0f172a,#1e293b,#0f172a);color:#fff;padding:12px 16px;position:sticky;top:0;z-index:100;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .header-content{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
    .header-left{display:flex;align-items:center;gap:12px}
    .header-icon{background:#3b82f6;padding:10px;border-radius:12px;font-size:20px}
    .header-title{font-size:18px;font-weight:700}
    .header-subtitle{font-size:12px;color:#94a3b8}
    .header-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .btn-new{background:#3b82f6;color:#fff;border:none;padding:10px 20px;border-radius:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px}
    .btn-new:hover{background:#2563eb}
    .btn-save{background:#10b981;color:#fff;border:none;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn-save:hover{background:#059669}
    .btn-load{background:#6366f1;color:#fff;border:none;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn-load:hover{background:#4f46e5}
    .btn-trades{background:#f59e0b;color:#fff;border:none;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn-trades:hover{background:#d97706}
    .main{max-width:1400px;margin:0 auto;padding:16px}
    .sync-banner{background:#dbeafe;border:2px solid #3b82f6;border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .sync-banner.warning{background:#fef3c7;border-color:#f59e0b}
    .sync-banner.success{background:#d1fae5;border-color:#10b981}
    .sync-text{font-size:14px;color:#1e40af;flex:1}
    .sync-banner.warning .sync-text{color:#92400e}
    .sync-banner.success .sync-text{color:#065f46}
    .controls{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .controls-row{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px}
    .view-tabs{display:flex;background:#f1f5f9;border-radius:12px;padding:4px}
    .view-tab{padding:10px 16px;border:none;background:transparent;font-weight:600;color:#64748b;cursor:pointer;border-radius:8px;font-size:14px}
    .view-tab.active{background:#fff;color:#0f172a;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .btn-today{padding:10px 16px;background:transparent;border:none;color:#3b82f6;font-weight:600;cursor:pointer;border-radius:8px}
    .btn-today:hover{background:#eff6ff}
    .jobs-legend{margin-top:16px;padding-top:16px;border-top:1px solid #e2e8f0}
    .legend-title{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
    .legend-items{display:flex;flex-wrap:wrap;gap:8px}
    .legend-item{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:8px;cursor:pointer;border:2px solid}
    .legend-item:hover{transform:scale(1.05);box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .legend-dot{width:12px;height:12px;border-radius:50%}
    .legend-name{font-size:13px;font-weight:600}
    .conflict-warning{background:#fef3c7;border:2px solid #fcd34d;border-radius:16px;padding:16px;margin-bottom:16px;display:flex;gap:12px}
    .conflict-title{font-weight:700;color:#92400e;margin-bottom:4px}
    .conflict-list{font-size:14px;color:#a16207}
    .conflict-item{margin-top:4px}
    .nav-bar{display:flex;align-items:center;justify-content:space-between;background:#fff;border-radius:16px;padding:12px 16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .nav-btn{width:40px;height:40px;border:none;background:#f1f5f9;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
    .nav-btn:hover{background:#e2e8f0}
    .nav-title{font-size:18px;font-weight:700;color:#1e293b}
    .nav-date-input{font-size:14px;color:#3b82f6;background:transparent;border:none;cursor:pointer;margin-top:4px}
    .week-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    @media(min-width:1024px){.week-grid{grid-template-columns:repeat(4,1fr)}}
    @media(min-width:1280px){.week-grid{grid-template-columns:repeat(7,1fr)}}
    .day-card{background:#fff;border-radius:16px;overflow:hidden;border:2px solid #e2e8f0}
    .day-card.today{border-color:#3b82f6;box-shadow:0 4px 6px -1px rgba(59,130,246,.2)}
    .day-card.weekend{background:#fffbeb}
    .day-header{padding:10px 12px;border-bottom:1px solid #e2e8f0;font-weight:700;font-size:14px}
    .day-header.today{background:#3b82f6;color:#fff}
    .day-content{padding:8px;min-height:120px}
    .no-work{color:#94a3b8;font-size:13px;text-align:center;padding:40px 10px}
    .event-card{border-radius:10px;padding:10px;margin-bottom:8px;cursor:pointer;border-left:4px solid}
    .event-card:hover{box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .event-job{font-weight:700;font-size:13px;margin-bottom:4px}
    .event-task{font-size:12px;color:#475569;margin-bottom:8px;line-height:1.4}
    .event-trades{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px}
    .event-notes{font-size:11px;background:rgba(255,255,255,.6);padding:6px 8px;border-radius:6px;color:#475569;font-style:italic;border-left:2px solid #cbd5e1}
    .trade-badge{display:inline-block;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:600;color:#fff;white-space:nowrap}
    .trade-badge.large{padding:5px 12px;font-size:13px}
    .daily-view{display:flex;flex-direction:column;gap:16px}
    .daily-job-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);border:2px solid}
    .daily-job-header{padding:16px;color:#fff}
    .daily-job-name{font-size:20px;font-weight:700}
    .daily-job-address{font-size:14px;opacity:.9;margin-top:4px}
    .daily-job-content{padding:20px}
    .daily-section{margin-bottom:20px}
    .daily-label{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
    .daily-task{font-size:15px;color:#1e293b;font-weight:500}
    .daily-trades{display:flex;flex-wrap:wrap;gap:8px}
    .daily-notes-input{width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;resize:none;font-family:inherit}
    .daily-notes-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .operatives-summary{background:linear-gradient(135deg,#1e293b,#334155);border-radius:16px;padding:20px;color:#fff}
    .operatives-title{font-weight:700;font-size:16px;margin-bottom:16px}
    .operative-row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.1);padding:10px 12px;border-radius:10px;margin-bottom:8px}
    .operative-jobs{font-size:13px;color:#cbd5e1}
    .month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e2e8f0;border:1px solid #e2e8f0;border-radius:16px;overflow:hidden}
    .month-header{background:#1e293b;color:#fff;padding:10px;text-align:center;font-weight:600;font-size:13px}
    .month-day{background:#fff;min-height:120px;padding:6px;vertical-align:top}
    .month-day.weekend{background:#fffbeb}
    .month-day.other-month{background:#f8fafc}
    .month-day.other-month .month-day-num{color:#94a3b8}
    .month-day.today{box-shadow:inset 0 0 0 2px #3b82f6}
    .month-day-num{font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;text-align:right}
    .month-event{font-size:10px;padding:3px 5px;border-radius:4px;margin-bottom:3px;cursor:pointer;overflow:hidden;color:#fff;line-height:1.3}
    .month-event:hover{opacity:.8}
    .month-more{font-size:10px;color:#3b82f6;cursor:pointer;text-align:center}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:200}
    .modal{background:#fff;border-radius:20px;width:100%;max-width:600px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px -12px rgba(0,0,0,.25)}
    .modal-header{background:linear-gradient(90deg,#3b82f6,#2563eb);padding:20px 24px;border-radius:20px 20px 0 0;display:flex;align-items:center;justify-content:space-between}
    .modal-title{color:#fff;font-size:20px;font-weight:700}
    .modal-close{background:transparent;border:none;color:rgba(255,255,255,.8);cursor:pointer;padding:8px;border-radius:8px;font-size:24px}
    .modal-close:hover{background:rgba(255,255,255,.1);color:#fff}
    .modal-body{padding:24px;overflow-y:auto;flex:1}
    .modal-footer{padding:16px 24px;border-top:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-radius:0 0 20px 20px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
    @media(max-width:500px){.form-row{grid-template-columns:1fr}}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}
    .form-input{width:100%;padding:10px 14px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}
    .form-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .color-picker{display:flex;gap:8px;flex-wrap:wrap}
    .color-btn{width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;color:#fff;font-weight:700}
    .color-btn:hover{transform:scale(1.1)}
    .color-btn.selected{box-shadow:0 0 0 3px #fff,0 0 0 5px #64748b}
    .timeline-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .btn-add-day{background:#eff6ff;color:#3b82f6;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px}
    .btn-add-day:hover{background:#dbeafe}
    .timeline-list{max-height:300px;overflow-y:auto}
    .timeline-day{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin-bottom:12px}
    .timeline-day-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .timeline-day-num{background:#fff;padding:4px 12px;border-radius:6px;font-weight:700;color:#374151;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .btn-remove-day{background:transparent;border:none;color:#ef4444;cursor:pointer;padding:4px 8px;border-radius:4px;font-size:14px}
    .btn-remove-day:hover{background:#fef2f2}
    .trades-input{width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:13px;margin-top:8px}
    .trades-hint{font-size:11px;color:#64748b;margin-top:4px}
    .btn{padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer;border:none;font-size:14px}
    .btn-primary{background:#3b82f6;color:#fff}
    .btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#e2e8f0;color:#475569}
    .btn-secondary:hover{background:#cbd5e1}
    .btn-danger{background:transparent;color:#ef4444}
    .btn-danger:hover{background:#fef2f2}
    .trades-manager{max-height:400px;overflow-y:auto}
    .trade-row{display:flex;gap:10px;align-items:center;padding:8px;background:#f8fafc;border-radius:8px;margin-bottom:8px}
    .trade-row input{flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:13px}
    .add-trade-btn{width:100%;padding:10px;background:#eff6ff;color:#3b82f6;border:2px dashed #3b82f6;border-radius:8px;font-weight:600;cursor:pointer;margin-top:8px}
    .add-trade-btn:hover{background:#dbeafe}
    .file-input-wrapper{position:relative;overflow:hidden;display:inline-block}
    .file-input-wrapper input[type=file]{position:absolute;left:0;top:0;opacity:0;cursor:pointer;width:100%;height:100%}
  </style>
</head>
<body>
<div id="app"></div>
<script>
var DEFAULT_TRADES = [
  {name:'Plumber',color:'#3B82F6',contact:''},
  {name:'Electrician',color:'#F59E0B',contact:''},
  {name:'Joiner',color:'#8B5CF6',contact:''},
  {name:'Plasterer',color:'#EC4899',contact:''},
  {name:'Tiler',color:'#10B981',contact:''},
  {name:'Labourer',color:'#6B7280',contact:''},
  {name:'Brickie',color:'#EF4444',contact:''},
  {name:'Roofer',color:'#0EA5E9',contact:''},
  {name:'Decorator',color:'#A855F7',contact:''},
  {name:'Gas',color:'#F97316',contact:''},
  {name:'Dan',color:'#14B8A6',contact:''},
  {name:'Dean',color:'#84CC16',contact:''},
  {name:'Graham',color:'#06B6D4',contact:''},
  {name:'Steven',color:'#D946EF',contact:''},
  {name:'Metal Worker',color:'#78716C',contact:''},
  {name:'Scaffolder',color:'#0D9488',contact:''}
];

var JOB_COLORS = [
  {bg:'#1E40AF',light:'#DBEAFE',border:'#3B82F6'},
  {bg:'#047857',light:'#D1FAE5',border:'#10B981'},
  {bg:'#B91C1C',light:'#FEE2E2',border:'#EF4444'},
  {bg:'#7C3AED',light:'#EDE9FE',border:'#8B5CF6'},
  {bg:'#B45309',light:'#FEF3C7',border:'#F59E0B'},
  {bg:'#0F766E',light:'#CCFBF1',border:'#14B8A6'},
  {bg:'#BE185D',light:'#FCE7F3',border:'#EC4899'},
  {bg:'#4338CA',light:'#E0E7FF',border:'#6366F1'}
];

var today = new Date();
var todayStr = today.toISOString().split('T')[0];

function addDaysToDate(d,n){var r=new Date(d);r.setDate(r.getDate()+n);return r.toISOString().split('T')[0]}

var DEFAULT_DATA = {
  trades: DEFAULT_TRADES,
  jobs: [],
  lastModified: new Date().toISOString()
};

var state = {
  data: JSON.parse(localStorage.getItem('jobSchedulerData')) || DEFAULT_DATA,
  currentDate: new Date(),
  view: 'week',
  showNewJobModal: false,
  editingJob: null,
  selectedEvent: null,
  showTradesModal: false,
  syncStatus: 'local',
  lastSaved: null
};

var tempJobData = null;

function saveToLocalStorage() {
  state.data.lastModified = new Date().toISOString();
  localStorage.setItem('jobSchedulerData', JSON.stringify(state.data));
}

function exportToFile() {
  var dataStr = JSON.stringify(state.data, null, 2);
  var blob = new Blob([dataStr], {type: 'text/plain'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'JobSchedulerData.txt';
  a.click();
  URL.revokeObjectURL(url);
  state.syncStatus = 'saved';
  state.lastSaved = new Date();
  render();
}

function importFromFile(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var imported = JSON.parse(e.target.result);
      if (imported.jobs && imported.trades) {
        state.data = imported;
        saveToLocalStorage();
        state.syncStatus = 'loaded';
        render();
        alert('Data loaded successfully!');
      } else {
        alert('Invalid file format');
      }
    } catch(err) {
      alert('Error reading file: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function formatDate(d){return d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})}
function formatDateShort(d){return d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})}
function isSameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function isWeekend(d){var day=d.getDay();return day===0||day===6}
function getWeekStart(d){var r=new Date(d),day=r.getDay(),diff=r.getDate()-day+(day===0?-6:1);return new Date(r.setDate(diff))}
function addDays(d,n){var r=new Date(d);r.setDate(r.getDate()+n);return r}

function getTradeColor(tradeName) {
  var name = tradeName.split('-')[0].trim().toLowerCase();
  for(var i=0;i<state.data.trades.length;i++){
    if(state.data.trades[i].name.toLowerCase()===name)return state.data.trades[i].color;
  }
  return '#6B7280';
}

function getEvents(){
  var events=[];
  for(var j=0;j<state.data.jobs.length;j++){
    var job=state.data.jobs[j];
    var start=new Date(job.startDate);
    for(var i=0;i<job.timeline.length;i++){
      var item=job.timeline[i];
      var date=addDays(start,item.day-1);
      events.push({date:date.toISOString().split('T')[0],job:job,day:item.day,task:item.task,trades:item.trades,notes:item.notes});
    }
  }
  return events;
}

function getConflicts(){
  var events=getEvents(),byDate={};
  for(var i=0;i<events.length;i++){
    var e=events[i];
    var trades=e.trades.split(',');
    for(var j=0;j<trades.length;j++){
      var t=trades[j].trim();
      if(t){
        var k=e.date+'|'+t.split('-')[0].trim();
        if(!byDate[k])byDate[k]=[];
        byDate[k].push(e.job.name);
      }
    }
  }
  var result=[];
  for(var key in byDate){
    if(byDate[key].length>1){
      var parts=key.split('|');
      result.push({date:parts[0],trade:parts[1],jobs:byDate[key]});
    }
  }
  return result;
}

function getEventsForDate(d){
  var s=d.toISOString().split('T')[0];
  var events=getEvents();
  var result=[];
  for(var i=0;i<events.length;i++){
    if(events[i].date===s)result.push(events[i]);
  }
  return result;
}

function render(){
  document.getElementById('app').innerHTML=
    renderHeader()+
    '<main class="main">'+
      renderSyncBanner()+
      renderConflicts()+
      renderControls()+
      (state.view==='month'?renderMonthView():state.view==='week'?renderWeekView():renderDailyView())+
    '</main>'+
    (state.showNewJobModal||state.editingJob?renderJobModal():'')+
    (state.selectedEvent?renderEventModal():'')+
    (state.showTradesModal?renderTradesModal():'');
}

function renderHeader(){
  return '<header class="header"><div class="header-content">'+
    '<div class="header-left">'+
      '<div class="header-icon">üìÖ</div>'+
      '<div><div class="header-title">Job Scheduler</div><div class="header-subtitle">Construction Team Planner</div></div>'+
    '</div>'+
    '<div class="header-buttons">'+
      '<button class="btn-trades" onclick="openTradesModal()">üë∑ Trades</button>'+
      '<div class="file-input-wrapper">'+
        '<button class="btn-load">üìÇ Load</button>'+
        '<input type="file" accept=".json,.txt" onchange="handleFileSelect(event)">'+
      '</div>'+
      '<button class="btn-save" onclick="exportToFile()">üíæ Save</button>'+
      '<button class="btn-new" onclick="openNewJobModal()">+ New Job</button>'+
    '</div>'+
  '</div></header>';
}

function renderSyncBanner(){
  var cls='sync-banner';
  var text='';
  if(state.syncStatus==='local'){
    cls+=' warning';
    text='‚ö†Ô∏è <strong>OneDrive Sync:</strong> Click Load to open your shared data file. Click Save after making changes.';
  }else if(state.syncStatus==='saved'){
    cls+=' success';
    text='‚úÖ Data saved! Save the .txt file to your shared OneDrive folder.';
  }else if(state.syncStatus==='loaded'){
    cls+=' success';
    text='‚úÖ Data loaded. Remember to Save after making changes.';
  }
  return '<div class="'+cls+'"><div class="sync-text">'+text+'</div></div>';
}

function renderConflicts(){
  var c=getConflicts();
  if(!c.length)return'';
  var items='';
  for(var i=0;i<Math.min(c.length,5);i++){
    items+='<div class="conflict-item"><strong>'+c[i].trade+'</strong> double-booked on '+formatDateShort(new Date(c[i].date))+': '+c[i].jobs.join(' & ')+'</div>';
  }
  return'<div class="conflict-warning"><div>‚ö†Ô∏è</div><div><div class="conflict-title">Scheduling Conflicts</div><div class="conflict-list">'+items+'</div></div></div>';
}

function renderControls(){
  var jobsHtml='';
  if(state.data.jobs.length){
    jobsHtml='<div class="jobs-legend"><div class="legend-title">Active Jobs (click to edit)</div><div class="legend-items">';
    for(var i=0;i<state.data.jobs.length;i++){
      var j=state.data.jobs[i];
      var c=JOB_COLORS[j.colorIndex%JOB_COLORS.length];
      jobsHtml+='<div class="legend-item" style="background:'+c.light+';border-color:'+c.border+'" onclick="editJob('+j.id+')"><div class="legend-dot" style="background:'+c.bg+'"></div><span class="legend-name" style="color:'+c.bg+'">'+j.name+'</span></div>';
    }
    jobsHtml+='</div></div>';
  }
  return'<div class="controls"><div class="controls-row">'+
    '<div class="view-tabs">'+
      '<button class="view-tab '+(state.view==='daily'?'active':'')+'" onclick="setView(\'daily\')">üìÖ Day</button>'+
      '<button class="view-tab '+(state.view==='week'?'active':'')+'" onclick="setView(\'week\')">üìã Week</button>'+
      '<button class="view-tab '+(state.view==='month'?'active':'')+'" onclick="setView(\'month\')">üóìÔ∏è Month</button>'+
    '</div>'+
    '<button class="btn-today" onclick="goToToday()">Today</button>'+
  '</div>'+jobsHtml+'</div>';
}

function renderMonthView(){
  var year=state.currentDate.getFullYear();
  var month=state.currentDate.getMonth();
  var firstDay=new Date(year,month,1);
  var lastDay=new Date(year,month+1,0);
  var startDay=firstDay.getDay()||7;
  var monthName=state.currentDate.toLocaleDateString('en-GB',{month:'long',year:'numeric'});
  
  var days=[];
  for(var i=startDay-1;i>0;i--)days.push({date:new Date(year,month,1-i),other:true});
  for(var i=1;i<=lastDay.getDate();i++)days.push({date:new Date(year,month,i),other:false});
  var remaining=42-days.length;
  for(var i=1;i<=remaining;i++)days.push({date:new Date(year,month+1,i),other:true});
  
  var daysHtml='';
  for(var i=0;i<days.length;i++){
    var d=days[i];
    var evts=getEventsForDate(d.date);
    var isT=isSameDay(d.date,new Date());
    var wknd=isWeekend(d.date);
    var cls='month-day';
    if(d.other)cls+=' other-month';
    if(isT)cls+=' today';
    if(wknd)cls+=' weekend';
    
    var evtsHtml='';
    for(var j=0;j<Math.min(evts.length,3);j++){
      var e=evts[j];
      var c=JOB_COLORS[e.job.colorIndex%JOB_COLORS.length];
      var notePreview=e.notes?e.notes.substring(0,20)+(e.notes.length>20?'...':''):'';
      evtsHtml+='<div class="month-event" style="background:'+c.bg+'" onclick="openEvent('+e.job.id+','+e.day+')" title="'+e.job.name+': '+e.task+'"><strong>'+e.job.name.split('-')[0].trim()+'</strong>'+(notePreview?'<br><span style="font-weight:normal;opacity:0.9">'+notePreview+'</span>':'')+'</div>';
    }
    if(evts.length>3){
      evtsHtml+='<div class="month-more" onclick="goToDate(\''+d.date.toISOString().split('T')[0]+'\')">+'+(evts.length-3)+' more</div>';
    }
    
    daysHtml+='<div class="'+cls+'"><div class="month-day-num">'+d.date.getDate()+'</div>'+evtsHtml+'</div>';
  }
  
  return '<div class="nav-bar">'+
      '<button class="nav-btn" onclick="navigateMonth(-1)">‚óÄ</button>'+
      '<div class="nav-title">'+monthName+'</div>'+
      '<button class="nav-btn" onclick="navigateMonth(1)">‚ñ∂</button>'+
    '</div>'+
    '<div class="month-grid">'+
      '<div class="month-header">Mon</div><div class="month-header">Tue</div><div class="month-header">Wed</div>'+
      '<div class="month-header">Thu</div><div class="month-header">Fri</div><div class="month-header">Sat</div><div class="month-header">Sun</div>'+
      daysHtml+
    '</div>';
}

function renderWeekView(){
  var ws=getWeekStart(state.currentDate);
  var daysHtml='';
  for(var i=0;i<7;i++){
    daysHtml+=renderDayCard(addDays(ws,i));
  }
  return'<div class="nav-bar"><button class="nav-btn" onclick="navigate(-7)">‚óÄ</button><div style="text-align:center"><div class="nav-title">Week of '+formatDateShort(ws)+'</div></div><button class="nav-btn" onclick="navigate(7)">‚ñ∂</button></div><div class="week-grid">'+daysHtml+'</div>';
}

function renderDayCard(d){
  var isT=isSameDay(d,new Date()),wknd=isWeekend(d),evts=getEventsForDate(d);
  var cls='day-card';
  if(isT)cls+=' today';
  if(wknd)cls+=' weekend';
  
  var content='';
  if(!evts.length){
    content='<div class="no-work">No work scheduled</div>';
  }else{
    for(var i=0;i<evts.length;i++){
      var e=evts[i];
      var c=JOB_COLORS[e.job.colorIndex%JOB_COLORS.length];
      var trades=e.trades.split(',');
      var tradesHtml='';
      for(var j=0;j<trades.length;j++){
        var t=trades[j].trim();
        if(t)tradesHtml+='<span class="trade-badge" style="background:'+getTradeColor(t)+'">'+t+'</span>';
      }
      content+='<div class="event-card" style="background:'+c.light+';border-color:'+c.border+'" onclick="openEvent('+e.job.id+','+e.day+')">'+
        '<div class="event-job" style="color:'+c.bg+'">'+e.job.name+'</div>'+
        '<div class="event-task">'+e.task+'</div>'+
        '<div class="event-trades">'+tradesHtml+'</div>'+
        (e.notes?'<div class="event-notes">üìù '+e.notes+'</div>':'')+
      '</div>';
    }
  }
  
  return'<div class="'+cls+'"><div class="day-header '+(isT?'today':'')+'">'+formatDate(d)+'</div><div class="day-content">'+content+'</div></div>';
}

function renderDailyView(){
  var evts=getEventsForDate(state.currentDate),ds=state.currentDate.toISOString().split('T')[0];
  var tradeJobs={};
  for(var i=0;i<evts.length;i++){
    var trades=evts[i].trades.split(',');
    for(var j=0;j<trades.length;j++){
      var t=trades[j].trim();
      if(t){
        if(!tradeJobs[t])tradeJobs[t]=[];
        tradeJobs[t].push(evts[i].job.name);
      }
    }
  }
  
  var cardsHtml='';
  if(!evts.length){
    cardsHtml='<div style="background:#fff;border-radius:16px;padding:48px;text-align:center;color:#64748b">No work scheduled for this day</div>';
  }else{
    for(var i=0;i<evts.length;i++){
      var e=evts[i];
      var c=JOB_COLORS[e.job.colorIndex%JOB_COLORS.length];
      var trades=e.trades.split(',');
      var tradesHtml='';
      for(var j=0;j<trades.length;j++){
        var t=trades[j].trim();
        if(t)tradesHtml+='<span class="trade-badge large" style="background:'+getTradeColor(t)+'">'+t+'</span>';
      }
      cardsHtml+='<div class="daily-job-card" style="border-color:'+c.border+'">'+
        '<div class="daily-job-header" style="background:'+c.bg+'">'+
          '<div class="daily-job-name">'+e.job.name+'</div>'+
          '<div class="daily-job-address">üìç '+(e.job.address||'No address')+'</div>'+
        '</div>'+
        '<div class="daily-job-content">'+
          '<div class="daily-section"><div class="daily-label">Day '+e.day+' - Task</div><div class="daily-task">'+e.task+'</div></div>'+
          '<div class="daily-section"><div class="daily-label">Trades on Site</div><div class="daily-trades">'+tradesHtml+'</div></div>'+
          '<div class="daily-section"><div class="daily-label">Daily Notes</div><textarea class="daily-notes-input" rows="2" placeholder="Add notes..." onchange="updateNotes('+e.job.id+','+e.day+',this.value)">'+(e.notes||'')+'</textarea></div>'+
        '</div>'+
      '</div>';
    }
  }
  
  var opsHtml='';
  var tradeKeys=Object.keys(tradeJobs);
  if(!tradeKeys.length){
    opsHtml='<div style="color:#94a3b8">No operatives needed</div>';
  }else{
    for(var i=0;i<tradeKeys.length;i++){
      var t=tradeKeys[i];
      opsHtml+='<div class="operative-row"><span class="trade-badge" style="background:'+getTradeColor(t)+'">'+t+'</span><span class="operative-jobs">'+tradeJobs[t].join(', ')+'</span></div>';
    }
  }
  
  return'<div class="daily-view">'+
    '<div class="nav-bar"><button class="nav-btn" onclick="navigate(-1)">‚óÄ</button><div style="text-align:center"><div class="nav-title">'+formatDate(state.currentDate)+'</div><input type="date" class="nav-date-input" value="'+ds+'" onchange="setDate(this.value)"></div><button class="nav-btn" onclick="navigate(1)">‚ñ∂</button></div>'+
    cardsHtml+
    '<div class="operatives-summary"><div class="operatives-title">üë∑ Operatives Summary</div>'+opsHtml+'</div>'+
  '</div>';
}

function renderJobModal(){
  var j=tempJobData||state.editingJob||{name:'',client:'',address:'',startDate:todayStr,colorIndex:Math.floor(Math.random()*JOB_COLORS.length),timeline:[{day:1,task:'',trades:'',notes:''}]};
  if(!tempJobData)tempJobData=JSON.parse(JSON.stringify(j));
  
  var colorsHtml='';
  for(var i=0;i<JOB_COLORS.length;i++){
    colorsHtml+='<button type="button" class="color-btn '+(tempJobData.colorIndex===i?'selected':'')+'" style="background:'+JOB_COLORS[i].bg+'" onclick="selectColor('+i+')">'+(tempJobData.colorIndex===i?'‚úì':'')+'</button>';
  }
  
  var timelineHtml='';
  for(var i=0;i<tempJobData.timeline.length;i++){
    var item=tempJobData.timeline[i];
    timelineHtml+='<div class="timeline-day">'+
      '<div class="timeline-day-header">'+
        '<span class="timeline-day-num">Day '+item.day+'</span>'+
        (tempJobData.timeline.length>1?'<button type="button" class="btn-remove-day" onclick="removeTimelineDay('+i+')">üóë Remove</button>':'')+
      '</div>'+
      '<input type="text" class="form-input" placeholder="Task description..." value="'+(item.task||'')+'" onchange="updateTimelineTask('+i+',this.value)">'+
      '<input type="text" class="trades-input" placeholder="Trades: e.g., Plumber, Electrician, Dan" value="'+(item.trades||'')+'" onchange="updateTimelineTrades('+i+',this.value)">'+
      '<div class="trades-hint">Separate multiple trades with commas</div>'+
      '<input type="text" class="form-input" style="margin-top:8px" placeholder="Notes..." value="'+(item.notes||'')+'" onchange="updateTimelineNotes('+i+',this.value)">'+
    '</div>';
  }
  
  return'<div class="modal-overlay" onclick="closeModals()"><div class="modal" onclick="event.stopPropagation()">'+
    '<div class="modal-header"><div class="modal-title">'+(state.editingJob?'Edit Job':'New Job')+'</div><button class="modal-close" onclick="closeModals()">√ó</button></div>'+
    '<div class="modal-body">'+
      '<div class="form-row">'+
        '<div class="form-group"><label class="form-label">Job Name *</label><input type="text" class="form-input" id="job-name" value="'+(tempJobData.name||'')+'" placeholder="e.g., Smith - Kitchen"></div>'+
        '<div class="form-group"><label class="form-label">Client</label><input type="text" class="form-input" id="job-client" value="'+(tempJobData.client||'')+'" placeholder="e.g., John Smith"></div>'+
      '</div>'+
      '<div class="form-row">'+
        '<div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" id="job-address" value="'+(tempJobData.address||'')+'" placeholder="e.g., 123 High Street"></div>'+
        '<div class="form-group"><label class="form-label">Start Date *</label><input type="date" class="form-input" id="job-start" value="'+(tempJobData.startDate||todayStr)+'"></div>'+
      '</div>'+
      '<div class="form-group"><label class="form-label">Job Colour</label><div class="color-picker">'+colorsHtml+'</div></div>'+
      '<div class="form-group">'+
        '<div class="timeline-header"><label class="form-label" style="margin:0">Timeline</label><button type="button" class="btn-add-day" onclick="addTimelineDay()">+ Add Day</button></div>'+
        '<div class="timeline-list">'+timelineHtml+'</div>'+
      '</div>'+
    '</div>'+
    '<div class="modal-footer">'+
      (state.editingJob?'<button class="btn btn-danger" onclick="deleteJob('+tempJobData.id+')">Delete Job</button>':'<div></div>')+
      '<div style="display:flex;gap:12px">'+
        '<button class="btn btn-secondary" onclick="closeModals()">Cancel</button>'+
        '<button class="btn btn-primary" onclick="saveJob()">‚úì '+(state.editingJob?'Update':'Create')+'</button>'+
      '</div>'+
    '</div>'+
  '</div></div>';
}

function renderEventModal(){
  var e=state.selectedEvent,c=JOB_COLORS[e.job.colorIndex%JOB_COLORS.length];
  var trades=e.trades.split(',');
  var tradesHtml='';
  for(var i=0;i<trades.length;i++){
    var t=trades[i].trim();
    if(t)tradesHtml+='<span class="trade-badge large" style="background:'+getTradeColor(t)+'">'+t+'</span>';
  }
  return'<div class="modal-overlay" onclick="closeModals()"><div class="modal" style="max-width:450px" onclick="event.stopPropagation()">'+
    '<div class="modal-header" style="background:'+c.bg+'"><div><div class="modal-title">'+e.job.name+'</div><div style="color:rgba(255,255,255,.8);font-size:14px">'+(e.job.address||'')+'</div></div><button class="modal-close" onclick="closeModals()">√ó</button></div>'+
    '<div class="modal-body">'+
      '<div class="daily-section"><div class="daily-label">Day '+e.day+' - '+formatDate(new Date(e.date))+'</div><div class="daily-task">'+e.task+'</div></div>'+
      '<div class="daily-section"><div class="daily-label">Trades</div><div class="daily-trades">'+tradesHtml+'</div></div>'+
      '<div class="daily-section"><div class="daily-label">Notes</div><textarea class="daily-notes-input" rows="3" id="event-notes" placeholder="Add notes...">'+(e.notes||'')+'</textarea></div>'+
    '</div>'+
    '<div class="modal-footer"><button class="btn btn-secondary" onclick="editJob('+e.job.id+')">Edit Job</button><button class="btn btn-primary" onclick="saveEventNotes()">Save Notes</button></div>'+
  '</div></div>';
}

function renderTradesModal(){
  var tradesHtml='';
  for(var i=0;i<state.data.trades.length;i++){
    var t=state.data.trades[i];
    tradesHtml+='<div class="trade-row">'+
      '<input type="text" value="'+(t.name||'')+'" placeholder="Trade name" onchange="updateTradeName('+i+',this.value)">'+
      '<input type="text" value="'+(t.contact||'')+'" placeholder="Contact/Name" onchange="updateTradeContact('+i+',this.value)">'+
      '<input type="color" value="'+t.color+'" style="width:40px;height:32px;border:none;cursor:pointer" onchange="updateTradeColor('+i+',this.value)">'+
      '<button onclick="removeTrade('+i+')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:18px">√ó</button>'+
    '</div>';
  }
  return'<div class="modal-overlay" onclick="closeModals()"><div class="modal" onclick="event.stopPropagation()">'+
    '<div class="modal-header" style="background:#f59e0b"><div class="modal-title">üë∑ Manage Trades</div><button class="modal-close" onclick="closeModals()">√ó</button></div>'+
    '<div class="modal-body">'+
      '<p style="margin-bottom:16px;color:#64748b;font-size:14px">Add trades and operatives here.</p>'+
      '<div class="trades-manager">'+tradesHtml+'</div>'+
      '<button class="add-trade-btn" onclick="addTrade()">+ Add Trade</button>'+
    '</div>'+
    '<div class="modal-footer"><div></div><button class="btn btn-primary" onclick="closeModals()">Done</button></div>'+
  '</div></div>';
}

window.setView=function(v){state.view=v;render()};
window.goToToday=function(){state.currentDate=new Date();render()};
window.navigate=function(n){state.currentDate=addDays(state.currentDate,n);render()};
window.navigateMonth=function(n){state.currentDate=new Date(state.currentDate.getFullYear(),state.currentDate.getMonth()+n,1);render()};
window.setDate=function(s){state.currentDate=new Date(s);render()};
window.goToDate=function(s){state.currentDate=new Date(s);state.view='daily';render()};

window.openNewJobModal=function(){state.showNewJobModal=true;state.editingJob=null;tempJobData={id:null,name:'',client:'',address:'',startDate:todayStr,colorIndex:Math.floor(Math.random()*JOB_COLORS.length),timeline:[{day:1,task:'',trades:'',notes:''}]};render()};
window.editJob=function(id){var j=null;for(var i=0;i<state.data.jobs.length;i++){if(state.data.jobs[i].id===id){j=state.data.jobs[i];break;}}if(j){state.editingJob=j;state.showNewJobModal=false;state.selectedEvent=null;tempJobData=JSON.parse(JSON.stringify(j));render()}};
window.closeModals=function(){state.showNewJobModal=false;state.editingJob=null;state.selectedEvent=null;state.showTradesModal=false;tempJobData=null;render()};
window.selectColor=function(i){if(tempJobData){tempJobData.colorIndex=i;render()}};
window.addTimelineDay=function(){if(tempJobData){tempJobData.timeline.push({day:tempJobData.timeline.length+1,task:'',trades:'',notes:''});render()}};
window.removeTimelineDay=function(i){if(tempJobData&&tempJobData.timeline.length>1){tempJobData.timeline.splice(i,1);for(var j=0;j<tempJobData.timeline.length;j++)tempJobData.timeline[j].day=j+1;render()}};
window.updateTimelineTask=function(i,v){if(tempJobData)tempJobData.timeline[i].task=v};
window.updateTimelineTrades=function(i,v){if(tempJobData)tempJobData.timeline[i].trades=v};
window.updateTimelineNotes=function(i,v){if(tempJobData)tempJobData.timeline[i].notes=v};

window.saveJob=function(){
  var n=document.getElementById('job-name').value.trim();
  var c=document.getElementById('job-client').value.trim();
  var a=document.getElementById('job-address').value.trim();
  var s=document.getElementById('job-start').value;
  if(!n||!s){alert('Please enter a job name and start date');return}
  var d={id:tempJobData.id,name:n,client:c,address:a,startDate:s,colorIndex:tempJobData.colorIndex,timeline:tempJobData.timeline};
  if(d.id){for(var i=0;i<state.data.jobs.length;i++){if(state.data.jobs[i].id===d.id){state.data.jobs[i]=d;break;}}}else{d.id=Date.now();state.data.jobs.push(d)}
  saveToLocalStorage();
  closeModals();
};

window.deleteJob=function(id){if(confirm('Delete this job?')){var newJobs=[];for(var i=0;i<state.data.jobs.length;i++){if(state.data.jobs[i].id!==id)newJobs.push(state.data.jobs[i]);}state.data.jobs=newJobs;saveToLocalStorage();closeModals()}};
window.openEvent=function(jid,day){var j=null;for(var i=0;i<state.data.jobs.length;i++){if(state.data.jobs[i].id===jid){j=state.data.jobs[i];break;}}if(j){var item=null;for(var i=0;i<j.timeline.length;i++){if(j.timeline[i].day===day){item=j.timeline[i];break;}}var date=addDays(new Date(j.startDate),day-1);state.selectedEvent={job:j,day:item.day,task:item.task,trades:item.trades,notes:item.notes,date:date.toISOString().split('T')[0]};render()}};
window.updateNotes=function(jid,day,notes){for(var i=0;i<state.data.jobs.length;i++){if(state.data.jobs[i].id===jid){for(var k=0;k<state.data.jobs[i].timeline.length;k++){if(state.data.jobs[i].timeline[k].day===day){state.data.jobs[i].timeline[k].notes=notes;saveToLocalStorage();return;}}}}};
window.saveEventNotes=function(){updateNotes(state.selectedEvent.job.id,state.selectedEvent.day,document.getElementById('event-notes').value);closeModals()};

window.openTradesModal=function(){state.showTradesModal=true;render()};
window.updateTradeName=function(i,v){state.data.trades[i].name=v;saveToLocalStorage()};
window.updateTradeContact=function(i,v){state.data.trades[i].contact=v;saveToLocalStorage()};
window.updateTradeColor=function(i,v){state.data.trades[i].color=v;saveToLocalStorage();render()};
window.addTrade=function(){state.data.trades.push({name:'',color:'#6B7280',contact:''});saveToLocalStorage();render()};
window.removeTrade=function(i){if(confirm('Remove this trade?')){state.data.trades.splice(i,1);saveToLocalStorage();render()}};

window.handleFileSelect=function(e){var file=e.target.files[0];if(file)importFromFile(file)};

render();
</script>
</body>
</html>
