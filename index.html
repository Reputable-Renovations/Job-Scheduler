<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Job Scheduler</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#f1f5f9,#e2e8f0);min-height:100vh}.header{background:linear-gradient(90deg,#0f172a,#1e293b,#0f172a);color:#fff;padding:12px 16px;position:sticky;top:0;z-index:100;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}.header-content{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}.header-left{display:flex;align-items:center;gap:12px}.header-icon{background:#3b82f6;padding:10px;border-radius:12px;font-size:20px}.header-title{font-size:18px;font-weight:700}.header-subtitle{font-size:12px;color:#94a3b8}.header-buttons{display:flex;gap:8px;flex-wrap:wrap}.btn-new{background:#3b82f6;color:#fff;border:none;padding:10px 20px;border-radius:12px;font-weight:600;cursor:pointer}.btn-new:hover{background:#2563eb}.btn-trades{background:#f59e0b;color:#fff;border:none;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer}.btn-trades:hover{background:#d97706}.btn-refresh{background:#10b981;color:#fff;border:none;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer}.btn-refresh:hover{background:#059669}.main{max-width:1400px;margin:0 auto;padding:16px}.sync-banner{background:#d1fae5;border:2px solid #10b981;border-radius:12px;padding:12px 16px;margin-bottom:16px}.sync-banner.syncing{background:#dbeafe;border-color:#3b82f6}.sync-banner.error{background:#fee2e2;border-color:#ef4444}.sync-text{font-size:14px;color:#065f46}.sync-banner.syncing .sync-text{color:#1e40af}.sync-banner.error .sync-text{color:#991b1b}.controls{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}.controls-row{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px}.view-tabs{display:flex;background:#f1f5f9;border-radius:12px;padding:4px}.view-tab{padding:10px 16px;border:none;background:transparent;font-weight:600;color:#64748b;cursor:pointer;border-radius:8px;font-size:14px}.view-tab.active{background:#fff;color:#0f172a;box-shadow:0 1px 3px rgba(0,0,0,.1)}.btn-today{padding:10px 16px;background:transparent;border:none;color:#3b82f6;font-weight:600;cursor:pointer;border-radius:8px}.btn-today:hover{background:#eff6ff}.jobs-legend{margin-top:16px;padding-top:16px;border-top:1px solid #e2e8f0}.legend-title{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}.legend-items{display:flex;flex-wrap:wrap;gap:8px}.legend-item{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:8px;cursor:pointer;border:2px solid}.legend-item:hover{transform:scale(1.05)}.legend-dot{width:12px;height:12px;border-radius:50%}.legend-name{font-size:13px;font-weight:600}.conflict-warning{background:#fef3c7;border:2px solid #fcd34d;border-radius:16px;padding:16px;margin-bottom:16px;display:flex;gap:12px}.conflict-title{font-weight:700;color:#92400e;margin-bottom:4px}.conflict-list{font-size:14px;color:#a16207}.conflict-item{margin-top:4px}.nav-bar{display:flex;align-items:center;justify-content:space-between;background:#fff;border-radius:16px;padding:12px 16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}.nav-btn{width:40px;height:40px;border:none;background:#f1f5f9;border-radius:10px;cursor:pointer;font-size:18px}.nav-btn:hover{background:#e2e8f0}.nav-title{font-size:18px;font-weight:700;color:#1e293b}.nav-date-input{font-size:14px;color:#3b82f6;background:transparent;border:none;cursor:pointer;margin-top:4px}.week-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}@media(min-width:1024px){.week-grid{grid-template-columns:repeat(4,1fr)}}@media(min-width:1280px){.week-grid{grid-template-columns:repeat(7,1fr)}}.day-card{background:#fff;border-radius:16px;overflow:hidden;border:2px solid #e2e8f0}.day-card.today{border-color:#3b82f6}.day-card.weekend{background:#fffbeb}.day-header{padding:10px 12px;border-bottom:1px solid #e2e8f0;font-weight:700;font-size:14px}.day-header.today{background:#3b82f6;color:#fff}.day-content{padding:8px;min-height:120px}.no-work{color:#94a3b8;font-size:13px;text-align:center;padding:40px 10px}.event-card{border-radius:10px;padding:10px;margin-bottom:8px;cursor:pointer;border-left:4px solid}.event-card:hover{box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}.event-job{font-weight:700;font-size:13px;margin-bottom:4px}.event-task{font-size:12px;color:#475569;margin-bottom:8px}.event-trades{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px}.event-notes{font-size:11px;background:rgba(255,255,255,.6);padding:6px 8px;border-radius:6px;color:#475569;font-style:italic}.trade-badge{display:inline-block;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:600;color:#fff}.trade-badge.large{padding:5px 12px;font-size:13px}.daily-view{display:flex;flex-direction:column;gap:16px}.daily-job-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);border:2px solid}.daily-job-header{padding:16px;color:#fff}.daily-job-name{font-size:20px;font-weight:700}.daily-job-address{font-size:14px;opacity:.9;margin-top:4px}.daily-job-content{padding:20px}.daily-section{margin-bottom:20px}.daily-label{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}.daily-task{font-size:15px;color:#1e293b;font-weight:500}.daily-trades{display:flex;flex-wrap:wrap;gap:8px}.daily-notes-input{width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;resize:none;font-family:inherit}.daily-notes-input:focus{outline:none;border-color:#3b82f6}.operatives-summary{background:linear-gradient(135deg,#1e293b,#334155);border-radius:16px;padding:20px;color:#fff}.operatives-title{font-weight:700;font-size:16px;margin-bottom:16px}.operative-row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.1);padding:10px 12px;border-radius:10px;margin-bottom:8px}.operative-jobs{font-size:13px;color:#cbd5e1}.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e2e8f0;border:1px solid #e2e8f0;border-radius:16px;overflow:hidden}.month-header{background:#1e293b;color:#fff;padding:10px;text-align:center;font-weight:600;font-size:13px}.month-day{background:#fff;min-height:140px;padding:6px}.month-day.weekend{background:#fffbeb}.month-day.other-month{background:#f8fafc}.month-day.other-month .month-day-num{color:#94a3b8}.month-day.today{box-shadow:inset 0 0 0 2px #3b82f6}.month-day-num{font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;text-align:right}.month-event{font-size:10px;padding:4px 5px;border-radius:4px;margin-bottom:4px;cursor:pointer;overflow:hidden;color:#fff;line-height:1.25}.month-event:hover{opacity:.8}.month-more{font-size:10px;color:#3b82f6;cursor:pointer;text-align:center}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:200}.modal{background:#fff;border-radius:20px;width:100%;max-width:600px;max-height:90vh;display:flex;flex-direction:column}.modal-header{background:linear-gradient(90deg,#3b82f6,#2563eb);padding:20px 24px;border-radius:20px 20px 0 0;display:flex;align-items:center;justify-content:space-between}.modal-title{color:#fff;font-size:20px;font-weight:700}.modal-close{background:transparent;border:none;color:rgba(255,255,255,.8);cursor:pointer;padding:8px;border-radius:8px;font-size:24px}.modal-close:hover{color:#fff}.modal-body{padding:24px;overflow-y:auto;flex:1}.modal-footer{padding:16px 24px;border-top:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-radius:0 0 20px 20px}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}@media(max-width:500px){.form-row{grid-template-columns:1fr}}.form-group{margin-bottom:16px}.form-label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}.form-input{width:100%;padding:10px 14px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}.form-input:focus{outline:none;border-color:#3b82f6}.color-picker{display:flex;gap:8px;flex-wrap:wrap}.color-btn{width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;color:#fff;font-weight:700}.color-btn:hover{transform:scale(1.1)}.color-btn.selected{box-shadow:0 0 0 3px #fff,0 0 0 5px #64748b}.timeline-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}.btn-add-day{background:#eff6ff;color:#3b82f6;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px}.btn-add-day:hover{background:#dbeafe}.timeline-list{max-height:300px;overflow-y:auto}.timeline-day{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin-bottom:12px}.timeline-day-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}.timeline-day-num{background:#fff;padding:4px 12px;border-radius:6px;font-weight:700;color:#374151}.btn-remove-day{background:transparent;border:none;color:#ef4444;cursor:pointer;padding:4px 8px;border-radius:4px;font-size:14px}.btn-remove-day:hover{background:#fef2f2}.trades-input{width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:13px;margin-top:8px}.trades-hint{font-size:11px;color:#64748b;margin-top:4px}.btn{padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer;border:none;font-size:14px}.btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}.btn-secondary{background:#e2e8f0;color:#475569}.btn-secondary:hover{background:#cbd5e1}.btn-danger{background:transparent;color:#ef4444}.btn-danger:hover{background:#fef2f2}.trades-manager{max-height:400px;overflow-y:auto}.trade-row{display:flex;gap:10px;align-items:center;padding:8px;background:#f8fafc;border-radius:8px;margin-bottom:8px}.trade-row input{flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:13px}.add-trade-btn{width:100%;padding:10px;background:#eff6ff;color:#3b82f6;border:2px dashed #3b82f6;border-radius:8px;font-weight:600;cursor:pointer;margin-top:8px}.add-trade-btn:hover{background:#dbeafe}.trade-selector{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;padding:8px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0}.trade-select-btn{padding:4px 10px;border-radius:16px;font-size:11px;font-weight:600;cursor:pointer;border:2px solid #e2e8f0;background:#fff;color:#374151}.trade-select-btn:hover{border-color:#3b82f6;background:#eff6ff}.trade-select-btn.selected{background:#3b82f6;color:#fff;border-color:#3b82f6}.loading{display:flex;align-items:center;justify-content:center;padding:60px;color:#64748b;font-size:16px}
  </style>
</head>
<body>
<div id="app"><div class="loading">‚òÅÔ∏è Loading from cloud...</div></div>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyCxe3kQqiwUEfgdkGv8pVTyP8PdY-iwliI",authDomain:"job-scheduler-4a4c2.firebaseapp.com",projectId:"job-scheduler-4a4c2",storageBucket:"job-scheduler-4a4c2.firebasestorage.app",messagingSenderId:"47069266602",appId:"1:47069266602:web:4c490d74cc462084bc86d3"});
var db=firebase.firestore();
var DEFAULT_TRADES=[{name:'Plumber',color:'#3B82F6',contact:''},{name:'Electrician',color:'#F59E0B',contact:''},{name:'Joiner',color:'#8B5CF6',contact:''},{name:'Plasterer',color:'#EC4899',contact:''},{name:'Tiler',color:'#10B981',contact:''},{name:'Labourer',color:'#6B7280',contact:''},{name:'Brickie',color:'#EF4444',contact:''},{name:'Roofer',color:'#0EA5E9',contact:''},{name:'Decorator',color:'#A855F7',contact:''},{name:'Gas',color:'#F97316',contact:''},{name:'Dan',color:'#14B8A6',contact:''},{name:'Dean',color:'#84CC16',contact:''},{name:'Graham',color:'#06B6D4',contact:''},{name:'Steven',color:'#D946EF',contact:''},{name:'Metal Worker',color:'#78716C',contact:''},{name:'Scaffolder',color:'#0D9488',contact:''}];
var JOB_COLORS=[{bg:'#1E40AF',light:'#DBEAFE',border:'#3B82F6'},{bg:'#047857',light:'#D1FAE5',border:'#10B981'},{bg:'#B91C1C',light:'#FEE2E2',border:'#EF4444'},{bg:'#7C3AED',light:'#EDE9FE',border:'#8B5CF6'},{bg:'#B45309',light:'#FEF3C7',border:'#F59E0B'},{bg:'#0F766E',light:'#CCFBF1',border:'#14B8A6'},{bg:'#BE185D',light:'#FCE7F3',border:'#EC4899'},{bg:'#4338CA',light:'#E0E7FF',border:'#6366F1'}];
var today=new Date(),todayStr=today.toISOString().split('T')[0];
var state={data:{trades:DEFAULT_TRADES,jobs:[]},currentDate:new Date(),view:'week',showNewJobModal:false,editingJob:null,selectedEvent:null,showTradesModal:false,syncStatus:'syncing',lastSync:null};
var tempJobData=null;
function loadFromCloud(){state.syncStatus='syncing';render();db.collection('scheduler').doc('data').get().then(function(doc){if(doc.exists)state.data=doc.data();state.syncStatus='synced';state.lastSync=new Date();render();}).catch(function(e){console.error(e);state.syncStatus='error';render();});}
function saveToCloud(){state.syncStatus='syncing';render();db.collection('scheduler').doc('data').set(state.data).then(function(){state.syncStatus='synced';state.lastSync=new Date();render();}).catch(function(e){console.error(e);state.syncStatus='error';render();});}
function formatDate(d){return d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})}
function formatDateShort(d){return d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})}
function isSameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function isWeekend(d){return d.getDay()===0||d.getDay()===6}
function getWeekStart(d){var r=new Date(d),day=r.getDay(),diff=r.getDate()-day+(day===0?-6:1);return new Date(r.setDate(diff))}
function addDays(d,n){var r=new Date(d);r.setDate(r.getDate()+n);return r}
function getTradeColor(tn){var n=tn.split('-')[0].trim().toLowerCase();for(var i=0;i<state.data.trades.length;i++)if(state.data.trades[i].name.toLowerCase()===n)return state.data.trades[i].color;return'#6B7280'}
function getEvents(){var ev=[];for(var j=0;j<state.data.jobs.length;j++){var job=state.data.jobs[j],start=new Date(job.startDate);for(var i=0;i<job.timeline.length;i++){var it=job.timeline[i],dt=addDays(start,it.day-1);ev.push({date:dt.toISOString().split('T')[0],job:job,day:it.day,task:it.task,trades:it.trades,notes:it.notes});}}return ev}
function getConflicts(){var ev=getEvents(),bd={};for(var i=0;i<ev.length;i++){var e=ev[i],tr=e.trades.split(',');for(var j=0;j<tr.length;j++){var t=tr[j].trim();if(t){var k=e.date+'|'+t.split('-')[0].trim();if(!bd[k])bd[k]=[];bd[k].push(e.job.name);}}}var r=[];for(var k in bd)if(bd[k].length>1){var p=k.split('|');r.push({date:p[0],trade:p[1],jobs:bd[k]});}return r}
function getEventsForDate(d){var s=d.toISOString().split('T')[0],ev=getEvents(),r=[];for(var i=0;i<ev.length;i++)if(ev[i].date===s)r.push(ev[i]);return r}
function render(){document.getElementById('app').innerHTML=renderHeader()+'<main class="main">'+renderSyncBanner()+renderConflicts()+renderControls()+(state.view==='month'?renderMonthView():state.view==='week'?renderWeekView():renderDailyView())+'</main>'+(state.showNewJobModal||state.editingJob?renderJobModal():'')+(state.selectedEvent?renderEventModal():'')+(state.showTradesModal?renderTradesModal():'');}
function renderHeader(){return'<header class="header"><div class="header-content"><div class="header-left"><div class="header-icon">üìÖ</div><div><div class="header-title">Job Scheduler</div><div class="header-subtitle">Construction Team Planner</div></div></div><div class="header-buttons"><button class="btn-trades" onclick="openTradesModal()">üë∑ Trades</button><button class="btn-refresh" onclick="loadFromCloud()">üîÑ Refresh</button><button class="btn-new" onclick="openNewJobModal()">+ New Job</button></div></div></header>';}
function renderSyncBanner(){var c='sync-banner',t='';if(state.syncStatus==='syncing'){c+=' syncing';t='üîÑ Syncing...';}else if(state.syncStatus==='synced'){var ts=state.lastSync?state.lastSync.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}):'';t='‚úÖ <strong>Live</strong> - Updated: '+ts;}else{c+=' error';t='‚ùå Error - Click Refresh';}return'<div class="'+c+'"><div class="sync-text">'+t+'</div></div>';}
function renderConflicts(){var c=getConflicts();if(!c.length)return'';var it='';for(var i=0;i<Math.min(c.length,5);i++)it+='<div class="conflict-item"><strong>'+c[i].trade+'</strong> on '+formatDateShort(new Date(c[i].date))+': '+c[i].jobs.join(' & ')+'</div>';return'<div class="conflict-warning"><div>‚ö†Ô∏è</div><div><div class="conflict-title">Conflicts</div><div class="conflict-list">'+it+'</div></div></div>';}
function renderControls(){var jh='';if(state.data.jobs.length){jh='<div class="jobs-legend"><div class="legend-title">Jobs (click to edit)</div><div class="legend-items">';for(var i=0;i<state.data.jobs.length;i++){var j=state.data.jobs[i],c=JOB_COLORS[j.colorIndex%JOB_COLORS.length];jh+='<div class="legend-item" style="background:'+c.light+';border-color:'+c.border+'" onclick="editJob('+j.id+')"><div class="legend-dot" style="background:'+c.bg+'"></div><span class="legend-name" style="color:'+c.bg+'">'+j.name+'</span></div>';}jh+='</div></div>';}return'<div class="controls"><div class="controls-row"><div class="view-tabs"><button class="view-tab '+(state.view==='daily'?'active':'')+'" onclick="setView(\'daily\')">üìÖ Day</button><button class="view-tab '+(state.view==='week'?'active':'')+'" onclick="setView(\'week\')">üìã Week</button><button class="view-tab '+(state.view==='month'?'active':'')+'" onclick="setView(\'month\')">üóìÔ∏è Month</button></div><button class="btn-today" onclick="goToToday()">Today</button></div>'+jh+'</div>';}
function renderMonthView(){var y=state.currentDate.getFullYear(),m=state.currentDate.getMonth(),fd=new Date(y,m,1),ld=new Date(y,m+1,0),sd=fd.getDay()||7,mn=state.currentDate.toLocaleDateString('en-GB',{month:'long',year:'numeric'});var ds=[];for(var i=sd-1;i>0;i--)ds.push({date:new Date(y,m,1-i),other:true});for(var i=1;i<=ld.getDate();i++)ds.push({date:new Date(y,m,i),other:false});var rem=42-ds.length;for(var i=1;i<=rem;i++)ds.push({date:new Date(y,m+1,i),other:true});var dh='';for(var i=0;i<ds.length;i++){var d=ds[i],ev=getEventsForDate(d.date),isT=isSameDay(d.date,new Date()),wk=isWeekend(d.date),cl='month-day';if(d.other)cl+=' other-month';if(isT)cl+=' today';if(wk)cl+=' weekend';var eh='';for(var j=0;j<Math.min(ev.length,2);j++){var e=ev[j],c=JOB_COLORS[e.job.colorIndex%JOB_COLORS.length],tp=e.task?e.task.substring(0,25)+(e.task.length>25?'...':''):'',trp=e.trades?e.trades.substring(0,20)+(e.trades.length>20?'...':''):'';eh+='<div class="month-event" style="background:'+c.bg+'" onclick="openEvent('+e.job.id+','+e.day+')"><strong>'+e.job.name.split('-')[0].trim()+'</strong>'+(tp?'<br><span style="font-weight:normal;opacity:0.9">'+tp+'</span>':'')+(trp?'<br><span style="font-weight:normal;font-size:9px;opacity:0.8">üë∑ '+trp+'</span>':'')+'</div>';}if(ev.length>2)eh+='<div class="month-more" onclick="goToDate(\''+d.date.toISOString().split('T')[0]+'\')">+'+(ev.length-2)+' more</div>';dh+='<div class="'+cl+'"><div class="month-day-num">'+d.date.getDate()+'</div>'+eh+'</div>';}return'<div class="nav-bar"><button class="nav-btn" onclick="navigateMonth(-1)">‚óÄ</button><div class="nav-title">'+mn+'</div><button class="nav-btn" onclick="navigateMonth(1)">‚ñ∂</button></div><div class="month-grid"><div class="month-header">Mon</div><div class="month-header">Tue</div><div class="month-header">Wed</div><div class="month-header">Thu</div><div class="month-header">Fri</div><div class="month-header">Sat</div><div class="month-header">Sun</div>'+dh+'</div>';}
function renderWeekView(){var ws=getWeekStart(state.currentDate),dh='';for(var i=0;i<7;i++)dh+=renderDayCard(addDays(ws,i));return'<div class="nav-bar"><button class="nav-btn" onclick="navigate(-7)">‚óÄ</button><div class="nav-title">Week of '+formatDateShort(ws)+'</div><button class="nav-btn" onclick="navigate(7)">‚ñ∂</button></div><div class="week-grid">'+dh+'</div>';}
function renderDayCard(d){var isT=isSameDay(d,new Date()),wk=isWeekend(d),ev=getEventsForDate(d),cl='day-card';if(isT)cl+=' today';if(wk)cl+=' weekend';var ct='';if(!ev.length)ct='<div class="no-work">No work</div>';else for(var i=0;i<ev.length;i++){var e=ev[i],c=JOB_COLORS[e.job.colorIndex%JOB_COLORS.length],tr=e.trades.split(','),th='';for(var j=0;j<tr.length;j++){var t=tr[j].trim();if(t)th+='<span class="trade-badge" style="background:'+getTradeColor(t)+'">'+t+'</span>';}ct+='<div class="event-card" style="background:'+c.light+';border-color:'+c.border+'" onclick="openEvent('+e.job.id+','+e.day+')"><div class="event-job" style="color:'+c.bg+'">'+e.job.name+'</div><div class="event-task">'+e.task+'</div><div class="event-trades">'+th+'</div>'+(e.notes?'<div class="event-notes">üìù '+e.notes+'</div>':'')+'</div>';}return'<div class="'+cl+'"><div class="day-header '+(isT?'today':'')+'">'+formatDate(d)+'</div><div class="day-content">'+ct+'</div></div>';}
function renderDailyView(){var ev=getEventsForDate(state.currentDate),ds=state.currentDate.toISOString().split('T')[0],tj={};for(var i=0;i<ev.length;i++){var tr=ev[i].trades.split(',');for(var j=0;j<tr.length;j++){var t=tr[j].trim();if(t){if(!tj[t])tj[t]=[];tj[t].push(ev[i].job.name);}}}var ch='';if(!ev.length)ch='<div style="background:#fff;border-radius:16px;padding:48px;text-align:center;color:#64748b">No work scheduled</div>';else for(var i=0;i<ev.length;i++){var e=ev[i],c=JOB_COLORS[e.job.colorIndex%JOB_COLORS.length],tr=e.trades.split(','),th='';for(var j=0;j<tr.length;j++){var t=tr[j].trim();if(t)th+='<span class="trade-badge large" style="background:'+getTradeColor(t)+'">'+t+'</span>';}ch+='<div class="daily-job-card" style="border-color:'+c.border+'"><div class="daily-job-header" style="background:'+c.bg+'"><div class="daily-job-name">'+e.job.name+'</div><div class="daily-job-address">üìç '+(e.job.address||'No address')+'</div></div><div class="daily-job-content"><div class="daily-section"><div class="daily-label">Day '+e.day+' - Task</div><div class="daily-task">'+e.task+'</div></div><div class="daily-section"><div class="daily-label">Trades</div><div class="daily-trades">'+th+'</div></div><div class="daily-section"><div class="daily-label">Notes</div><textarea class="daily-notes-input" rows="2" placeholder="Add notes..." onchange="updateNotes('+e.job.id+','+e.day+',this.value)">'+(e.notes||'')+'</textarea></div></div></div>';}var oh='',tk=Object.keys(tj);if(!tk.length)oh='<div style="color:#94a3b8">No operatives</div>';else for(var i=0;i<tk.length;i++){var t=tk[i];oh+='<div class="operative-row"><span class="trade-badge" style="background:'+getTradeColor(t)+'">'+t+'</span><span class="operative-jobs">'+tj[t].join(', ')+'</span></div>';}return'<div class="daily-view"><div class="nav-bar"><button class="nav-btn" onclick="navigate(-1)">‚óÄ</button><div style="text-align:center"><div class="nav-title">'+formatDate(state.currentDate)+'</div><input type="date" class="nav-date-input" value="'+ds+'" onchange="setDate(this.value)"></div><button class="nav-btn" onclick="navigate(1)">‚ñ∂</button></div>'+ch+'<div class="operatives-summary"><div class="operatives-title">üë∑ Operatives</div>'+oh+'</div></div>';}
function renderJobModal(){var j=tempJobData||state.editingJob||{name:'',client:'',address:'',startDate:todayStr,colorIndex:Math.floor(Math.random()*JOB_COLORS.length),timeline:[{day:1,task:'',trades:'',notes:''}]};if(!tempJobData)tempJobData=JSON.parse(JSON.stringify(j));var ch='';for(var i=0;i<JOB_COLORS.length;i++)ch+='<button type="button" class="color-btn '+(tempJobData.colorIndex===i?'selected':'')+'" style="background:'+JOB_COLORS[i].bg+'" onclick="selectColor('+i+')">'+(tempJobData.colorIndex===i?'‚úì':'')+'</button>';var tlh='';for(var i=0;i<tempJobData.timeline.length;i++){var it=tempJobData.timeline[i],st=(it.trades||'').split(',').map(function(t){return t.trim().toLowerCase()}).filter(function(t){return t}),tbh='';for(var t=0;t<state.data.trades.length;t++){var tr=state.data.trades[t];if(tr.name){var isSel=st.indexOf(tr.name.toLowerCase())>-1;tbh+='<button type="button" class="trade-select-btn'+(isSel?' selected':'')+'" style="'+(isSel?'background:'+tr.color+';border-color:'+tr.color:'border-color:'+tr.color+';color:'+tr.color)+'" onclick="toggleTrade('+i+',\''+tr.name+'\')">'+tr.name+'</button>';}}tlh+='<div class="timeline-day"><div class="timeline-day-header"><span class="timeline-day-num">Day '+it.day+'</span>'+(tempJobData.timeline.length>1?'<button type="button" class="btn-remove-day" onclick="removeTimelineDay('+i+')">üóë</button>':'')+'</div><input type="text" class="form-input" placeholder="Task..." value="'+(it.task||'')+'" onchange="updateTimelineTask('+i+',this.value)"><div class="trades-hint" style="margin-top:8px">Select trades:</div><div class="trade-selector">'+tbh+'</div><input type="text" class="trades-input" placeholder="Or type custom..." value="'+(it.trades||'')+'" onchange="updateTimelineTrades('+i+',this.value)"><input type="text" class="form-input" style="margin-top:8px" placeholder="Notes..." value="'+(it.notes||'')+'" onchange="updateTimelineNotes('+i+',this.value)"></div>';}return'<div class="modal-overlay" onclick="closeModals()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><div class="modal-title">'+(state.editingJob?'Edit Job':'New Job')+'</div><button class="modal-close" onclick="closeModals()">√ó</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label class="form-label">Job Name *</label><input type="text" class="form-input" id="job-name" value="'+(tempJobData.name||'')+'" placeholder="e.g., Smith - Kitchen"></div><div class="form-group"><label class="form-label">Client</label><input type="text" class="form-input" id="job-client" value="'+(tempJobData.client||'')+'" placeholder="Client name"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" id="job-address" value="'+(tempJobData.address||'')+'" placeholder="Address"></div><div class="form-group"><label class="form-label">Start Date *</label><input type="date" class="form-input" id="job-start" value="'+(tempJobData.startDate||todayStr)+'"></div></div><div class="form-group"><label class="form-label">Colour</label><div class="color-picker">'+ch+'</div></div><div class="form-group"><div class="timeline-header"><label class="form-label" style="margin:0">Timeline</label><button type="button" class="btn-add-day" onclick="addTimelineDay()">+ Add Day</button></div><div class="timeline-list">'+tlh+'</div></div></div><div class="modal-footer">'+(state.editingJob?'<button class="btn btn-danger" onclick="deleteJob('+tempJobData.id+')">Delete</button>':'<div></div>')+'<div style="display:flex;gap:12px"><button class="btn btn-secondary" onclick="closeModals()">Cancel</button><button class="btn btn-primary" onclick="saveJob()">‚úì Save</button></div></div></div></div>';}
function renderEventModal(){var e=state.selectedEvent,c=JOB_COLORS[e.job.colorIndex%JOB_COLORS.length],tr=e.trades.split(','),th='';for(var i=0;i<tr.length;i++){var t=tr[i].trim();if(t)th+='<span class="trade-badge large" style="background:'+getTradeColor(t)+'">'+t+'</span>';}return'<div class="modal-overlay" onclick="closeModals()"><div class="modal" style="max-width:450px" onclick="event.stopPropagation()"><div class="modal-header" style="background:'+c.bg+'"><div><div class="modal-title">'+e.job.name+'</div><div style="color:rgba(255,255,255,.8);font-size:14px">'+(e.job.address||'')+'</div></div><button class="modal-close" onclick="closeModals()">√ó</button></div><div class="modal-body"><div class="daily-section"><div class="daily-label">Day '+e.day+' - '+formatDate(new Date(e.date))+'</div><div class="daily-task">'+e.task+'</div></div><div class="daily-section"><div class="daily-label">Trades</div><div class="daily-trades">'+th+'</div></div><div class="daily-section"><div class="daily-label">Notes</div><textarea class="daily-notes-input" rows="3" id="event-notes" placeholder="Notes...">'+(e.notes||'')+'</textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="editJob('+e.job.id+')">Edit Job</button><button class="btn btn-primary" onclick="saveEventNotes()">Save</button></div></div></div>';}
function renderTradesModal(){var th='';for(var i=0;i<state.data.trades.length;i++){var t=state.data.trades[i];th+='<div class="trade-row"><input type="text" value="'+(t.name||'')+'" placeholder="Trade" onchange="updateTradeName('+i+',this.value)"><input type="text" value="'+(t.contact||'')+'" placeholder="Contact" onchange="updateTradeContact('+i+',this.value)"><input type="color" value="'+t.color+'" style="width:40px;height:32px;border:none;cursor:pointer" onchange="updateTradeColor('+i+',this.value)"><button onclick="removeTrade('+i+')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:18px">√ó</button></div>';}return'<div class="modal-overlay" onclick="closeModals()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header" style="background:#f59e0b"><div class="modal-title">üë∑ Trades</div><button class="modal-close" onclick="closeModals()">√ó</button></div><div class="modal-body"><div class="trades-manager">'+th+'</div><button class="add-trade-btn" onclick="addTrade()">+ Add Trade</button></div><div class="modal-footer"><div></div><button class="btn btn-primary" onclick="closeTradesModal()">Done</button></div></div></div>';}
window.setView=function(v){state.view=v;render()};window.goToToday=function(){state.currentDate=new Date();render()};window.navigate=function(n){state.currentDate=addDays(state.currentDate,n);render()};window.navigateMonth=function(n){state.currentDate=new Date(state.currentDate.getFullYear(),state.currentDate.getMonth()+n,1);render()};window.setDate=function(s){state.currentDate=new Date(s);render()};window.goToDate=function(s){state.currentDate=new Date(s);state.view='daily';render()};
window.openNewJobModal=function(){state.showNewJobModal=true;state.editingJob=null;tempJobData={id:null,name:'',client:'',address:'',startDate:todayStr,colorIndex:Math.floor(Math.random()*JOB_COLORS.length),timeline:[{day:1,task:'',trades:'',notes:''}]};render()};window.editJob=function(id){var j=null;for(var i=0;i<state.data.jobs.length;i++)if(state.data.jobs[i].id===id){j=state.data.jobs[i];break;}if(j){state.editingJob=j;state.showNewJobModal=false;state.selectedEvent=null;tempJobData=JSON.parse(JSON.stringify(j));render()}};window.closeModals=function(){state.showNewJobModal=false;state.editingJob=null;state.selectedEvent=null;state.showTradesModal=false;tempJobData=null;render()};window.selectColor=function(i){if(tempJobData){saveFormToTemp();tempJobData.colorIndex=i;render()}};window.addTimelineDay=function(){if(tempJobData){saveFormToTemp();tempJobData.timeline.push({day:tempJobData.timeline.length+1,task:'',trades:'',notes:''});render()}};window.removeTimelineDay=function(i){if(tempJobData&&tempJobData.timeline.length>1){saveFormToTemp();tempJobData.timeline.splice(i,1);for(var j=0;j<tempJobData.timeline.length;j++)tempJobData.timeline[j].day=j+1;render()}};window.updateTimelineTask=function(i,v){if(tempJobData)tempJobData.timeline[i].task=v};window.updateTimelineTrades=function(i,v){if(tempJobData){saveFormToTemp();tempJobData.timeline[i].trades=v;render()}};window.updateTimelineNotes=function(i,v){if(tempJobData)tempJobData.timeline[i].notes=v};window.toggleTrade=function(di,tn){if(!tempJobData)return;saveFormToTemp();var c=tempJobData.timeline[di].trades||'',tr=c.split(',').map(function(t){return t.trim()}).filter(function(t){return t}),ti=-1;for(var i=0;i<tr.length;i++)if(tr[i].toLowerCase()===tn.toLowerCase()){ti=i;break;}if(ti>-1)tr.splice(ti,1);else tr.push(tn);tempJobData.timeline[di].trades=tr.join(', ');render();};
window.saveFormToTemp=function(){if(!tempJobData)return;var n=document.getElementById('job-name'),c=document.getElementById('job-client'),a=document.getElementById('job-address'),s=document.getElementById('job-start');if(n)tempJobData.name=n.value;if(c)tempJobData.client=c.value;if(a)tempJobData.address=a.value;if(s)tempJobData.startDate=s.value;};
window.saveJob=function(){var n=document.getElementById('job-name').value.trim(),c=document.getElementById('job-client').value.trim(),a=document.getElementById('job-address').value.trim(),s=document.getElementById('job-start').value;if(!n||!s){alert('Enter job name and start date');return}var d={id:tempJobData.id,name:n,client:c,address:a,startDate:s,colorIndex:tempJobData.colorIndex,timeline:tempJobData.timeline};if(d.id){for(var i=0;i<state.data.jobs.length;i++)if(state.data.jobs[i].id===d.id){state.data.jobs[i]=d;break;}}else{d.id=Date.now();state.data.jobs.push(d)}saveToCloud();closeModals();};
window.deleteJob=function(id){if(confirm('Delete this job?')){var nj=[];for(var i=0;i<state.data.jobs.length;i++)if(state.data.jobs[i].id!==id)nj.push(state.data.jobs[i]);state.data.jobs=nj;saveToCloud();closeModals()}};window.openEvent=function(jid,day){var j=null;for(var i=0;i<state.data.jobs.length;i++)if(state.data.jobs[i].id===jid){j=state.data.jobs[i];break;}if(j){var it=null;for(var i=0;i<j.timeline.length;i++)if(j.timeline[i].day===day){it=j.timeline[i];break;}var dt=addDays(new Date(j.startDate),day-1);state.selectedEvent={job:j,day:it.day,task:it.task,trades:it.trades,notes:it.notes,date:dt.toISOString().split('T')[0]};render()}};window.updateNotes=function(jid,day,notes){for(var i=0;i<state.data.jobs.length;i++)if(state.data.jobs[i].id===jid){for(var k=0;k<state.data.jobs[i].timeline.length;k++)if(state.data.jobs[i].timeline[k].day===day){state.data.jobs[i].timeline[k].notes=notes;saveToCloud();return;}}};window.saveEventNotes=function(){updateNotes(state.selectedEvent.job.id,state.selectedEvent.day,document.getElementById('event-notes').value);closeModals()};
window.openTradesModal=function(){state.showTradesModal=true;render()};window.closeTradesModal=function(){state.showTradesModal=false;saveToCloud();render()};window.updateTradeName=function(i,v){state.data.trades[i].name=v};window.updateTradeContact=function(i,v){state.data.trades[i].contact=v};window.updateTradeColor=function(i,v){state.data.trades[i].color=v;render()};window.addTrade=function(){state.data.trades.push({name:'',color:'#6B7280',contact:''});render()};window.removeTrade=function(i){if(confirm('Remove?')){state.data.trades.splice(i,1);render()}};
loadFromCloud();
</script>
</body>
</html>
